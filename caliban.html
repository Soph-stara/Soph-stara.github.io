<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caliban's Daughters</title>
    <style>
        /* === SIMPLE STYLING === */
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a2e;
            color: #eee;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            text-align: center;
            background-color: #16213e;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
        }

        h1 {
            color: #e94560;
            margin-bottom: 10px;
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 15px;
            background-color: #0f3460;
            border-radius: 5px;
        }

        .stat-item {
            font-weight: bold;
        }

        .card-display {
            background-color: #e94560;
            color: white;
            padding: 15px;
            max-width: 400px;
            border-radius: 10px;
            margin: 20px auto;
            min-height: 200px;
        }

        .card-image {
            height: 180px;
            width: 120px;
            background-color: rgba(45, 27, 54, 0.1);
            margin: 10px auto;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border: 2px solid rgba(233, 69, 96, 0.3);
            font-size: 14px;
            text-align: center;
        }

        .card-image img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 3px;
        }

        .character-setup {
            background-color: rgba(233, 69, 96, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 3px solid #e94560;
        }

        .game-mechanics-preview {
            background-color: rgba(15, 52, 96, 0.5);
            padding: 12px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .choices {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        button {
            padding: 15px 25px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #e94560;
            color: white;
            flex: 1;
        }

        button:hover {
            background-color: #d63447;
        }

        .hidden {
            display: none;
        }

        .message {
            background-color: #0f3460;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-style: italic;
        }

        .story-section {
            margin: 20px 0;
            padding: 20px;
            background-color: #0f3460;
            border-radius: 8px;
            line-height: 1.6;
        }

        .story-btn {
            background-color: #16213e;
            color: #eee;
            border: 1px solid #e94560;
            margin: 10px 5px;
            padding: 10px 20px;
        }

        .story-btn:hover {
            background-color: #e94560;
        }

        /* Role selection styling */
        .roles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .role-btn {
            padding: 20px;
            background-color: #0f3460;
            border: 2px solid #e94560;
        }

        .role-btn:hover {
            background-color: #e94560;
        }
    </style>
</head>
<body>
    <!-- === GAME SCREENS === -->
    
    <!-- Start Screen -->
    <div id="start-screen" class="container">
        <h1>Caliban's Daughters</h1>
        <h3>A Game of Survival, Resistance, and Feminist History</h3>
        
        <!-- Story Introduction -->
        <div id="intro-story" class="story-section">
            <p><strong>Europe, 15th-17th centuries.</strong> The world is changing rapidly. Old ways of life are being destroyed as capitalism takes hold. Commons are being enclosed. Women are losing their economic independence.</p>
            
            <p>But the most dangerous change is yet to come: <em>the witch hunts.</em></p>
            
            <p>You are a woman with knowledge, skills, or independence that threatens the new social order. Your very existence is becoming suspicious...</p>
            
            <button onclick="showRoleSelection()" class="story-btn">Begin Your Story</button>
            <button onclick="showHistoricalContext()" class="story-btn">Learn More About This Period</button>
        </div>

        <!-- Historical Context Screen -->
        <div id="historical-context" class="story-section hidden">
            <h3>The Historical Context</h3>
            <p><strong>The witch hunts were not about superstition.</strong> As feminist historian Silvia Federici argues in "Caliban and the Witch," they were a systematic attack on women's autonomy during the rise of capitalism.</p>
            
            <h4>Why Women Were Targeted:</h4>
            <ul style="text-align: left; max-width: 500px; margin: 0 auto;">
                <li><strong>Economic Independence:</strong> Women who lived alone, had their own income, or controlled property</li>
                <li><strong>Traditional Knowledge:</strong> Healers, midwives, and herbalists whose skills challenged emerging male-dominated medicine</li>
                <li><strong>Resistance to Change:</strong> Those who opposed new laws restricting women's behavior and mobility</li>
                <li><strong>Control of Reproduction:</strong> Women who knew about contraception, abortion, or childbirth</li>
            </ul>
            
            <p><em>"The witch hunt was a war against women; it was a coordinated effort to degrade them, demonize them, and destroy their social power."</em> - Silvia Federici</p>
            
            <button onclick="showRoleSelection()" class="story-btn">Choose Your Role</button>
            <button onclick="showIntroStory()" class="story-btn">Back</button>
        </div>

        <!-- Role Selection Screen -->
        <div id="role-selection" class="story-section hidden">
            <h3>Who Are You?</h3>
            <p>Each woman faced different challenges and had different resources for survival:</p>
            
            <div class="roles">
                <button class="role-btn" onclick="showRoleDetails('healer')">
                    <strong>Healer</strong><br>
                    <small>Knows herbs and remedies</small>
                </button>
                <button class="role-btn" onclick="showRoleDetails('midwife')">
                    <strong>Midwife</strong><br>
                    <small>Helps with childbirth</small>
                </button>
                <button class="role-btn" onclick="showRoleDetails('wise-woman')">
                    <strong>Wise Woman</strong><br>
                    <small>Keeper of old knowledge</small>
                </button>
                <button class="role-btn" onclick="showRoleDetails('dissenter')">
                    <strong>Dissenter</strong><br>
                    <small>Speaks against injustice</small>
                </button>
            </div>
            
            <button onclick="showHistoricalContext()" class="story-btn">Learn More About This Period</button>
        </div>

        <!-- Individual Role Details -->
        <div id="role-details" class="story-section hidden">
            <div id="role-story-content"></div>
            <button id="start-game-btn" class="story-btn" onclick="confirmRole()">Begin as This Character</button>
            <button onclick="showRoleSelection()" class="story-btn">Choose Different Role</button>
        </div>
    </div>

    <!-- Character Introduction Screen -->
    <div id="character-intro" class="container hidden">
        <h1>Caliban's Daughters</h1>
        <div id="character-intro-content" class="story-section">
            <!-- Content will be filled by JavaScript -->
        </div>
        
        <div class="story-section">
            <h3>How to Play</h3>
            <p><strong>Each Round:</strong> You'll draw a tarot card representing a situation or challenge based on historical events during the witch hunts.</p>
            
            <p><strong>Your Choices:</strong> Each card offers two options - often a choice between safety and resistance, or between individual survival and helping others.</p>
            
            <p><strong>Consequences:</strong> Your choices affect your Suspicion Level and number of Allies. Both are crucial for survival.</p>
            
            <div class="game-mechanics-preview">
                <h4>Theoretical Foundation</h4>
                <p><em>This game is based on Silvia Federici's analysis in "Caliban and the Witch." You'll experience how the witch hunts functioned as a tool of primitive accumulation, destroying women's autonomy to enforce capitalist and patriarchal control.</em></p>
            </div>
        </div>
        
        <button onclick="proceedToGameplay()" class="story-btn">Begin Your Journey</button>
        <button onclick="showRoleSelection()" class="story-btn">Choose Different Character</button>
    </div>

    <!-- Main Game Screen -->
    <div id="game-screen" class="container hidden">
        <h1>Caliban's Daughters</h1>
        
        <!-- Game Statistics -->
        <div class="game-stats">
            <div class="stat-item">Suspicion: <span id="suspicion">0</span>%</div>
            <div class="stat-item">Allies: <span id="allies">0</span></div>
            <div class="stat-item">Round: <span id="round">1</span>/10</div>
        </div>

        <!-- Card Display Area -->
        <div class="card-display">
            <h2 id="card-title">Ready to Begin</h2>
            <div class="card-image" id="card-image">
                <img src="images/cover.jpg" alt="Caliban's Daughters Cover">
            </div>
            <p id="card-scenario">Your story as a woman during the witch hunts is about to unfold...</p>
            <p id="card-context">Each card you draw will present you with a choice that could mean survival or danger.</p>
        </div>

        <!-- Choice Buttons -->
        <div id="choices" class="choices hidden">
            <button id="choice-1" onclick="makeChoice(1)">
                <span id="choice-1-text">Choice 1</span>
            </button>
            <button id="choice-2" onclick="makeChoice(2)">
                <span id="choice-2-text">Choice 2</span>
            </button>
        </div>

        <!-- Draw Card Button -->
        <button id="draw-btn" onclick="drawCard()">Draw Card</button>

        <!-- Game Messages -->
        <div id="message" class="message hidden"></div>
    </div>

    <!-- End Screen -->
    <div id="end-screen" class="container hidden">
        <h1>Game Over</h1>
        <h2 id="end-title"></h2>
        <p id="end-message"></p>
        <div id="theory-message" class="story-section"></div>
        <button onclick="restartGame()">Play Again</button>
    </div>

    <script>
        // === GAME STATE ===
        let player = {
            role: null,
            suspicion: 0,
            allies: 0,
            round: 0,
            despair: 0,       // New stat for Level 2
            level2: false,    // Flag to check if we're in Level 2
            maxRounds: 10     // Default for Level 1
        };
        
        let currentCardIndex = 0;
        let usedCards = [];

        // === ROLE DATA ===
        const ROLES = {
            healer: {
                name: "Healer",
                description: "You know the secrets of herbs and remedies, passed down through generations of women. Your knowledge saves lives, but it also marks you as dangerous to those who fear female wisdom.",
                story: "As a healer, you possess ancient knowledge of plants, remedies, and the body's mysteries. In a world increasingly dominated by male physicians and church doctrine, your traditional wisdom represents both hope for the suffering and a threat to emerging power structures. Every person you heal could become an ally - or an accuser.",
                startingSuspicion: 10,
                startingAllies: 1
            },
            midwife: {
                name: "Midwife",
                description: "You bring new life into the world and know the intimate secrets of birth and death. Your presence at life's most vulnerable moments gives you great influence - and great danger.",
                story: "As a midwife, you hold power over life and death, birth and fertility. You know which herbs prevent pregnancy, which ease childbirth, and how to save mothers when others would let them die. This knowledge makes you invaluable - and terrifying to those who seek to control women's bodies and reproductive choices.",
                startingSuspicion: 15,
                startingAllies: 2
            },
            "wise-woman": {
                name: "Wise Woman",
                description: "You are the keeper of old knowledge - folklore, traditions, and wisdom that stretches back before written history. You remember the old ways that the new world seeks to destroy.",
                story: "As a wise woman, you are a living library of traditional knowledge. You know the old stories, the seasonal rituals, the ways of reading signs and omens. You understand the connections between all living things. But in a world that increasingly values only written, male-authorized knowledge, your wisdom is seen as primitive superstition - or dangerous witchcraft.",
                startingSuspicion: 5,
                startingAllies: 1
            },
            dissenter: {
                name: "Dissenter",
                description: "You speak out against injustice and refuse to accept the new restrictions being placed on women. Your voice of resistance inspires some and terrifies others.",
                story: "As a dissenter, you refuse to quietly accept the changes destroying women's lives. You speak out against unfair laws, challenge corrupt officials, and organize resistance. Your courage inspires other women, but it also paints a target on your back. Every act of defiance could be your last - or could spark the flame that lights a revolution.",
                startingSuspicion: 20,
                startingAllies: 0
            }
        };

        // === TAROT CARDS ===
        const TAROT_CARDS = [
            {
                title: "The Moon",
                image: "images/moon.jpg",
                scenario: "Whispers spread that you meet with spirits at night.",
                context: "Rumors could quickly become deadly accusations.",
                choice1: {
                    text: "Hide for a few nights",
                    effects: { suspicion: -15 },
                    message: "You stay hidden until the rumors die down."
                },
                choice2: {
                    text: "Confront the gossips",
                    effects: { suspicion: +20, allies: +1 },
                    message: "Your bold confrontation gains respect but draws attention."
                }
            },
            {
                title: "The Tower",
                image: "images/tower.jpg",
                scenario: "A local woman betrays your secret gathering.",
                context: "Trust could be broken by fear and desperation.",
                choice1: {
                    text: "Disperse quietly",
                    effects: { suspicion: -10 },
                    message: "You scatter safely but lose the gathering."
                },
                choice2: {
                    text: "Defy the accuser",
                    effects: { suspicion: +30, allies: -1 },
                    message: "Your defiance is seen as proof of guilt."
                }
            },
            {
                title: "The High Priestess",
                image: "images/high_priestess.jpg",
                scenario: "A woman in labor calls for your help.",
                context: "Healing knowledge was both valued and dangerous.",
                choice1: {
                    text: "Use your knowledge",
                    effects: { suspicion: +20, allies: +1 },
                    message: "You save mother and child, but your skills are noticed."
                },
                choice2: {
                    text: "Send someone else",
                    effects: { suspicion: -10 },
                    message: "You stay safe but offer no help."
                }
            },
            {
                title: "The Hermit",
                image: "images/hermit.jpg",
                scenario: "A woman from a neighboring village seeks your help, fleeing persecution.",
                context: "Networks of support among women were crucial for survival.",
                choice1: {
                    text: "Help her escape",
                    effects: { suspicion: +5, allies: +1 },
                    message: "You risk your safety to aid another. She will remember your kindness."
                },
                choice2: {
                    text: "Turn her away",
                    effects: { suspicion: -5 },
                    message: "You protect yourself, but lose a potential ally."
                }
            },
            {
                title: "Death",
                image: "images/death.jpg",
                scenario: "A woman in the village has been accused of witchcraft and awaits trial.",
                context: "Witch trials relied on community participation. Speaking out risked attention.",
                choice1: {
                    text: "Speak in her defense",
                    effects: { suspicion: +20, allies: +1 },
                    message: "Your words cast suspicion on you, but you've shown great courage."
                },
                choice2: {
                    text: "Stay silent",
                    effects: { suspicion: -5 },
                    message: "You preserve your safety, but the guilt weighs on you."
                }
            },
            {
                title: "The Devil",
                image: "images/devil.jpg",
                scenario: "The local priest warns about women who defy natural order and church teachings.",
                context: "Religious authorities played a central role in controlling women's knowledge.",
                choice1: {
                    text: "Question his teachings secretly",
                    effects: { allies: +1 },
                    message: "Others share your doubts. You form a quiet network of dissenters."
                },
                choice2: {
                    text: "Attend church dutifully",
                    effects: { suspicion: -10 },
                    message: "Your public piety provides some protection."
                }
            },
            {
                title: "The Empress",
                image: "images/empress.jpg",
                scenario: "Your knowledge of reproductive medicine could help a suffering noblewoman.",
                context: "Control over reproduction was a key battlefield during witch hunts.",
                choice1: {
                    text: "Offer your services",
                    effects: { suspicion: -15 },
                    message: "The noblewoman recovers and becomes your protector."
                },
                choice2: {
                    text: "Keep your knowledge hidden",
                    effects: { suspicion: -5 },
                    message: "You remain safe but unseen."
                }
            },
            {
                title: "Justice",
                image: "images/justice.jpg",
                scenario: "A local official offers you protection in exchange for naming other 'suspicious' women.",
                context: "The witch hunt machinery relied on forced confessions and denunciations.",
                choice1: {
                    text: "Refuse the offer",
                    effects: { suspicion: +15, allies: +1 },
                    message: "Your integrity remains intact, earning the trust of other women."
                },
                choice2: {
                    text: "Provide false names",
                    effects: { suspicion: -10 },
                    message: "You buy yourself time, but at what cost to your conscience?"
                }
            },
            {
                title: "The Star",
                image: "images/star.jpg",
                scenario: "A midnight gathering of women is planned to share knowledge and resources.",
                context: "Women's gatherings were often criminalized but important for mutual support.",
                choice1: {
                    text: "Attend the gathering",
                    effects: { suspicion: +10, allies: +2 },
                    message: "The connection with other women strengthens your resolve and knowledge."
                },
                choice2: {
                    text: "Stay home",
                    effects: { suspicion: -5 },
                    message: "You remain isolated but avoid immediate danger."
                }
            },
            {
                title: "Strength",
                image: "images/strength.jpg",
                scenario: "In the village square, a desperate woman is being publicly flogged for stealing bread to feed her children.",
                context: "Public punishments were designed to intimidate communities into compliance.",
                choice1: {
                    text: "Step in to stop it",
                    effects: { suspicion: +25, allies: +1 },
                    message: "Your quiet courage overcomes fear. You risk everything to protect the vulnerable."
                },
                choice2: {
                    text: "Look away in silence",
                    effects: { suspicion: -5 },
                    message: "You choose safety over moral action, but the weight sits heavy."
                }
            }
        ];

        // === LEVEL 2 TRIAL CARDS ===
        const TRIAL_CARDS = [
            {
                title: "The Arrest",
                scenario: "Authorities strip you and search for 'devil's marks' - any birthmark or scar is suspicious.",
                context: "The Malleus Maleficarum demanded thorough bodily examination for signs of witchcraft.",
                choice1: {
                    text: "Submit quietly",
                    effects: { despair: -10 },
                    message: "Your compliance shows 'proper fear of God' to the judges."
                },
                choice2: {
                    text: "Protest your innocence",
                    effects: { despair: +15 },
                    message: "Your protests are seen as defiance - more evidence of guilt."
                }
            },
            {
                title: "The Interrogation",
                scenario: "The judge asks you to confess 'freely' before torture begins. 'Confess now and we may spare your life.'",
                context: "Judges were instructed to promise leniency to encourage confession, though this was often false.",
                choice1: {
                    text: "Confess to minor charges",
                    effects: { despair: +20 },
                    message: "Your confession is recorded, but they demand names of other witches."
                },
                choice2: {
                    text: "Maintain innocence",
                    effects: { despair: +10 },
                    message: "Your refusal to confess means torture is 'necessary to find truth.'"
                }
            },
            {
                title: "The Strappado",
                scenario: "They prepare the pulley torture. 'Last chance to confess before we begin.'",
                context: "The strappado lifted victims by ropes tied to their wrists behind their backs.",
                choice1: {
                    text: "Confess under threat",
                    effects: { despair: +15 },
                    message: "You break before the torture begins. The confession must be 'freely' repeated later."
                },
                choice2: {
                    text: "Endure the torture",
                    effects: { despair: +25 },
                    message: "The pain is unbearable, but you must 'confirm' any confession made under torture."
                }
            },
            {
                title: "The Prison Cell",
                scenario: "Alone in your cell, the guards warn that the Devil will tempt you to suicide.",
                context: "Prisoners were watched constantly to prevent suicide, which would 'cheat' justice.",
                choice1: {
                    text: "Pray continuously",
                    effects: { despair: -15 },
                    message: "Prayer gives you strength and may impress the guards."
                },
                choice2: {
                    text: "Plan escape",
                    effects: { despair: +20 },
                    message: "Escape attempts prove your guilt - only the Devil could help you."
                }
            },
            {
                title: "Name Others",
                scenario: "They demand you name accomplices. 'Give us three names and avoid further torture.'",
                context: "The witch hunt system required accusations to spread and justify itself.",
                choice1: {
                    text: "Give false names",
                    effects: { despair: +30 },
                    message: "You doom innocent women, but the guilt may destroy your soul."
                },
                choice2: {
                    text: "Refuse to name anyone",
                    effects: { despair: +10 },
                    message: "Your silence protects others but ensures your own continued torture."
                }
            },
            {
                title: "The Final Judgment",
                scenario: "The judge announces your sentence. All your choices have led to this moment.",
                context: "Most trials ended in execution, but some received life imprisonment.",
                choice1: {
                    text: "Accept your fate",
                    effects: { despair: +5 },
                    message: "You find peace in acceptance as your ordeal nears its end."
                },
                choice2: {
                    text: "Make final appeal",
                    effects: { despair: +15 },
                    message: "Your desperate appeal is seen as proof you remain unrepentant."
                }
            }
        ];

        // === NAVIGATION FUNCTIONS ===
        function showScreen(screenId) {
            document.querySelectorAll('.container').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showIntroStory() {
            document.getElementById('intro-story').classList.remove('hidden');
            document.getElementById('historical-context').classList.add('hidden');
        }

        function showHistoricalContext() {
            document.getElementById('intro-story').classList.add('hidden');
            document.getElementById('historical-context').classList.remove('hidden');
        }

        function showRoleSelection() {
            document.getElementById('intro-story').classList.add('hidden');
            document.getElementById('historical-context').classList.add('hidden');
            document.getElementById('role-selection').classList.remove('hidden');
            document.getElementById('role-details').classList.add('hidden');
        }

        function showRoleDetails(roleKey) {
            const role = ROLES[roleKey];
            document.getElementById('role-selection').classList.add('hidden');
            document.getElementById('role-details').classList.remove('hidden');
            
            document.getElementById('role-story-content').innerHTML = `
                <h3>${role.name}</h3>
                <p><strong>${role.description}</strong></p>
                <p>${role.story}</p>
                <div class="character-setup">
                    <h4>Starting Attributes:</h4>
                    <p><strong>Suspicion:</strong> ${role.startingSuspicion}%</p>
                    <p><strong>Allies:</strong> ${role.startingAllies}</p>
                </div>
            `;
            
            // Store the selected role
            player.selectedRole = roleKey;
        }

        function confirmRole() {
            if (!player.selectedRole) return;
            
            const role = ROLES[player.selectedRole];
            player.role = role.name;
            player.suspicion = role.startingSuspicion;
            player.allies = role.startingAllies;
            player.round = 0;
            
            // Show character introduction
            showScreen('character-intro');
            document.getElementById('character-intro-content').innerHTML = `
                <h2>Welcome, ${role.name}</h2>
                <p>${role.story}</p>
                <div class="character-setup">
                    <h4>Your Starting Position:</h4>
                    <p><strong>Suspicion Level:</strong> ${player.suspicion}%</p>
                    <p><strong>Allies:</strong> ${player.allies}</p>
                    <p><strong>Role:</strong> ${role.name}</p>
                </div>
            `;
        }

        function proceedToGameplay() {
            showScreen('game-screen');
            updateStats();
            currentCardIndex = 0;
            usedCards = [];
        }

        // === GAME FUNCTIONS ===
        function updateStats() {
            document.getElementById('suspicion').textContent = Math.max(0, Math.min(100, player.suspicion));
            document.getElementById('allies').textContent = Math.max(0, player.allies);
            if (player.level2) {
                document.getElementById('despair').textContent = player.despair;
            }
            document.getElementById('round').textContent = player.round + 1;
        }

        function drawCard() {
            if (player.round >= 10) {
                endGame();
                return;
            }

            // Get a random unused card
            let availableCards = TAROT_CARDS.filter((card, index) => !usedCards.includes(index));
            if (availableCards.length === 0) {
                // Reset if we've used all cards
                usedCards = [];
                availableCards = TAROT_CARDS;
            }

            const randomIndex = Math.floor(Math.random() * availableCards.length);
            const card = availableCards[randomIndex];
            currentCardIndex = TAROT_CARDS.indexOf(card);
            usedCards.push(currentCardIndex);

            // Display the card
            document.getElementById('card-title').textContent = card.title;
            document.getElementById('card-image').innerHTML = `<img src="${card.image}" alt="${card.title}">`;
            document.getElementById('card-scenario').textContent = card.scenario;
            document.getElementById('card-context').textContent = card.context;

            // Show choices
            document.getElementById('choice-1-text').textContent = card.choice1.text;
            document.getElementById('choice-2-text').textContent = card.choice2.text;
            document.getElementById('choices').classList.remove('hidden');
            document.getElementById('draw-btn').classList.add('hidden');

            // Hide any previous message
            document.getElementById('message').classList.add('hidden');
        }

        function makeChoice(choice) {
            // Apply effects
            if (choice.effects.suspicion) {
                player.suspicion += choice.effects.suspicion;
                player.suspicion = Math.max(0, Math.min(100, player.suspicion));
            }

            if (choice.effects.allies) {
                player.allies += choice.effects.allies;
            }

            if (choice.effects.despair) {
                player.despair += choice.effects.despair;
                player.despair = Math.max(0, Math.min(100, player.despair));
            }

            updateStats();
            showMessage(choice.message);

            // Level 1 â†’ Level 2 trigger
            if (player.suspicion >= 100 && !player.level2) {
                setTimeout(() => startLevel2(), 2000);
                return;
            }

            // Level 2 end conditions
            if (player.level2 && player.despair >= 100) {
                setTimeout(() => endGame('broken'), 2000);
                return;
            }

            if (player.level2 && player.round > player.maxRounds) {
                if (player.despair <= 30) {
                    setTimeout(() => endGame('survived_trial'), 2000);
                } else {
                    setTimeout(() => endGame('executed'), 2000);
                }
                return;
            }

            // Move to next round
            player.round++;
            drawCard();
            }
            // Show message
            document.getElementById('message').textContent = choice.message;
            document.getElementById('message').classList.remove('hidden');

            // Update stats
            player.round++;
            updateStats();

            // Hide choices and show draw button
            document.getElementById('choices').classList.add('hidden');
            document.getElementById('draw-btn').classList.remove('hidden');

            // Check for immediate game over conditions
            if (player.suspicion >= 100 && !player.level2) {
                setTimeout(() => startLevel2(), 2000);
                return;
            }

            if (player.level2 && player.despair >= 100) {
                setTimeout(() => endGame('broken'), 2000);
                return;
            }

            if (player.level2 && player.round > player.maxRounds) {
                if (player.despair <= 30) {
                    setTimeout(() => endGame('survived_trial'), 2000);
                } else {
                    setTimeout(() => endGame('executed'), 2000);
                }
                return;
            }

            if (!player.level2 && player.round >= 10) {
                setTimeout(() => endGame(), 2000);
            }

        function startLevel2() {
            player.level2 = true;
            player.despair = 0;
            player.round = 1;
            player.maxRounds = 6;

            // You might want to shuffle TRIAL_CARDS here
            player.deck = [...TRIAL_CARDS];

            document.getElementById('card-title').textContent = "Level 2: The Trial";
            document.getElementById('card-scenario').textContent = "You have been captured...";
            document.getElementById('card-context').textContent = "Your goal is survival...";

            document.querySelector('.game-stats').innerHTML = `
                <div class="stat-item">Despair: <span id="despair">0</span>%</div>
                <div class="stat-item">Allies: <span id="allies">${player.allies}</span></div>
                <div class="stat-item">Trial Round: <span id="round">1</span>/6</div>
            `;

            document.getElementById('draw-btn').classList.remove('hidden');
        }

        function endGame() {
            showScreen('end-screen');
            
            let title, message, theory;
            
            if (player.suspicion >= 100) {
                title = "Condemned";
                message = "Your suspicion level reached 100%. The authorities have marked you as a witch, and your fate is sealed. Despite your best efforts, the machinery of persecution has claimed another victim.";
                theory = "This represents how the witch hunts functioned as a systematic tool of oppression. Individual choices mattered, but the system was designed to destroy women's autonomy regardless of guilt or innocence.";
            } else if (player.suspicion >= 70) {
                title = "Under Suspicion";
                message = "You survive, but barely. The community watches your every move, and one wrong step could be your last. You live in constant fear, your autonomy severely restricted.";
                theory = "Even women who avoided execution often lived under constant surveillance and control - which was part of the witch hunts' true purpose: to discipline all women into submission.";
            } else if (player.suspicion >= 40) {
                title = "Cautious Survivor";
                message = "You've managed to navigate the dangerous waters of suspicion while maintaining some allies. Your careful balance of resistance and discretion has kept you alive, but at what cost to your spirit?";
                theory = "Many women survived by carefully balancing compliance with resistance. This constant calculation was itself a form of oppression, forcing women to constantly police their own behavior.";
            } else {
                title = "Hidden Strength";
                message = "Against all odds, you've maintained your integrity while building a network of allies and keeping suspicion low. You represent the underground resistance that preserved women's knowledge through the darkest times.";
                theory = "Some women did successfully resist and preserve their autonomy, often by building strong networks of mutual support. These hidden communities kept alive the knowledge and solidarity that patriarchal capitalism sought to destroy.";
            }
            
            document.getElementById('end-title').textContent = title;
            document.getElementById('end-message').textContent = message;
            document.getElementById('theory-message').innerHTML = `
                <h4>Historical Analysis</h4>
                <p>${theory}</p>
                <p><strong>Final Stats:</strong> Suspicion: ${player.suspicion}%, Allies: ${player.allies}, Rounds Survived: ${player.round}</p>
            `;
        }

        function showBrokenEnding() {
            document.getElementById('end-title').textContent = "Your Spirit Was Broken";
            document.getElementById('end-message').innerHTML = `
                <p><strong>The torture and psychological pressure destroyed your will.</strong> Like many victims, you confessed to impossible crimes and named innocent people as accomplices.</p>
                <p><em>Final Stats: ${gameState.despair}% despair overwhelmed you during the trial process.</em></p>
            `;
            document.getElementById('theory-message').innerHTML = `
                <h3>The Machinery of Confession</h3>
                <p>The Malleus Maleficarum created a system designed to break the human spirit. Through torture, isolation, and false promises, it extracted confessions that 'proved' the witch hunt's validity.</p>
                <p>Your ending represents the countless women who were destroyed by this legal machinery of oppression.</p>
            `;
        }

        function showExecutedEnding() {
            document.getElementById('end-title').textContent = "You Were Executed";
            document.getElementById('end-message').innerHTML = `
                <p><strong>Despite surviving the trial process, you were sentenced to death.</strong> Your ${gameState.despair}% despair wasn't enough to break you completely, but the system claimed your life anyway.</p>
                <p><em>You maintained some dignity and resistance even in the face of death.</em></p>
            `;
        }

        function showSurvivedTrialEnding() {
            document.getElementById('end-title').textContent = "You Survived the Trial";
            document.getElementById('end-message').innerHTML = `
                <p><strong>Incredibly, you survived both levels of persecution.</strong> With only ${gameState.despair}% despair, you endured the trial and received life imprisonment instead of execution.</p>
                <p><em>You represent the rare few who survived the complete witch hunt process.</em></p>
            `;
        }

        function restartGame() {
            player = {
                role: null,
                suspicion: 0,
                allies: 0,
                round: 0,
                selectedRole: null
            };
            currentCardIndex = 0;
            usedCards = [];
            showScreen('start-screen');
            showIntroStory();
        }

        // Initialize game
        document.addEventListener('DOMContentLoaded', function() {
            showScreen('start-screen');
            showIntroStory();
        });
    </script>
</body>
</html>