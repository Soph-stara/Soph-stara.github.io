<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caliban's Daughters</title>
    <style>
        /* === SIMPLE STYLING === */
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a2e;
            color: #eee;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            text-align: center;
            background-color: #16213e;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
        }

        h1 {
            color: #e94560;
            margin-bottom: 10px;
        }

        .level-header {
            background-color: #0f3460;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 3px solid #e94560;
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 15px;
            background-color: #0f3460;
            border-radius: 5px;
        }

        .stat-item {
            font-weight: bold;
        }

        .card-display {
            background-color: #e94560;
            color: white;
            padding: 15px;
            max-width: 400px;
            border-radius: 10px;
            margin: 20px auto;
            min-height: 200px;
        }

        .trial-display {
            background-color: #8b0000;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px auto;
            min-height: 200px;
        }

        .trial-phase {
            font-size: 1.1em;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .card-image {
            height: 180px;
            width: 120px;
            background-color: rgba(45, 27, 54, 0.1);
            margin: 10px auto;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border: 2px solid rgba(233, 69, 96, 0.3);
            font-weight: bold;
            font-size: 14px;
            text-align: center;
        }

        .card-image img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 3px;
        }

        .character-setup {
            background-color: rgba(233, 69, 96, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 3px solid #e94560;
        }

        .game-mechanics-preview {
            background-color: rgba(15, 52, 96, 0.5);
            padding: 12px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .choices {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        button {
            padding: 15px 25px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #e94560;
            color: white;
            flex: 1;
        }

        button:hover {
            background-color: #d63447;
        }

        .hidden {
            display: none;
        }

        .message {
            background-color: #0f3460;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-style: italic;
        }

        .story-section {
            margin: 20px 0;
            padding: 20px;
            background-color: #0f3460;
            border-radius: 8px;
            line-height: 1.6;
        }

        .story-btn {
            background-color: #16213e;
            color: #eee;
            border: 1px solid #e94560;
            margin: 10px 5px;
            padding: 10px 20px;
        }

        .story-btn:hover {
            background-color: #e94560;
        }

        .ally-bonus {
            background-color: rgba(0, 128, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 3px solid #00ff00;
        }

        .transition-screen {
            background-color: #8b0000;
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin: 20px auto;
            text-align: center;
        }

        /* Role selection styling */
        .roles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .role-btn {
            padding: 20px;
            background-color: #0f3460;
            border: 2px solid #e94560;
        }

        .role-btn:hover {
            background-color: #e94560;
        }
    </style>
</head>
<body>
    <!-- === LEVEL 1 SCREENS === -->
    
    <!-- Start Screen -->
    <div id="start-screen" class="container">
        <h1>Caliban's Daughters</h1>
        <h3>A Game of Survival, Resistance, and Feminist History</h3>
        
        <!-- Story Introduction -->
        <div id="intro-story" class="story-section">
            <p><strong>Europe, 15th-17th centuries.</strong> The world is changing rapidly. Old ways of life are being destroyed as capitalism takes hold. Commons are being enclosed. Women are losing their economic independence.</p>
            
            <p>But the most dangerous change is yet to come: <em>the witch hunts.</em></p>
            
            <p>You are a woman with knowledge, skills, or independence that threatens the new social order. Your very existence is becoming suspicious...</p>
            
            <button onclick="showRoleSelection()" class="story-btn">Begin Your Story</button>
            <button onclick="showHistoricalContext()" class="story-btn">Learn More About This Period</button>
        </div>

        <!-- Historical Context Screen -->
        <div id="historical-context" class="story-section hidden">
            <h3>The Historical Context</h3>
            <p><strong>The witch hunts were not about superstition.</strong> As feminist historian Silvia Federici argues in "Caliban and the Witch," they were a systematic attack on women's autonomy during the rise of capitalism.</p>
            
            <h4>Why Women Were Targeted:</h4>
            <ul style="text-align: left; max-width: 500px; margin: 0 auto;">
                <li><strong>Economic Independence:</strong> Women who lived alone, had their own income, or controlled property</li>
                <li><strong>Traditional Knowledge:</strong> Healers, midwives, and herbalists whose skills challenged emerging male-dominated medicine</li>
                <li><strong>Resistance to Change:</strong> Those who opposed new laws restricting women's behavior and mobility</li>
                <li><strong>Control of Reproduction:</strong> Women who knew about contraception, abortion, or childbirth</li>
            </ul>
            
            <p><em>"The witch hunt was a war against women; it was a coordinated effort to degrade them, demonize them, and destroy their social power."</em> - Silvia Federici</p>
            
            <button onclick="showRoleSelection()" class="story-btn">Choose Your Role</button>
            <button onclick="showIntroStory()" class="story-btn">Back</button>
        </div>

        <!-- Role Selection Screen -->
        <div id="role-selection" class="story-section hidden">
            <h3>Who Are You?</h3>
            <p>Each woman faced different challenges and had different resources for survival:</p>
            
            <div class="roles">
                <button class="role-btn" onclick="showRoleDetails('healer')">
                    <strong>Healer</strong><br>
                    <small>Knows herbs and remedies</small>
                </button>
                <button class="role-btn" onclick="showRoleDetails('midwife')">
                    <strong>Midwife</strong><br>
                    <small>Helps with childbirth</small>
                </button>
                <button class="role-btn" onclick="showRoleDetails('wise-woman')">
                    <strong>Wise Woman</strong><br>
                    <small>Keeper of old knowledge</small>
                </button>
                <button class="role-btn" onclick="showRoleDetails('dissenter')">
                    <strong>Dissenter</strong><br>
                    <small>Speaks against injustice</small>
                </button>
            </div>
            
            <button onclick="showHistoricalContext()" class="story-btn">Learn More About This Period</button>
        </div>

        <!-- Individual Role Details -->
        <div id="role-details" class="story-section hidden">
            <div id="role-story-content"></div>
            <button id="start-game-btn" class="story-btn">Begin as This Character</button>
            <button onclick="showRoleSelection()" class="story-btn">Choose Different Role</button>
        </div>
    </div>

    <!-- Character Introduction Screen -->
    <div id="character-intro" class="container hidden">
        <h1>Caliban's Daughters</h1>
        <div id="character-intro-content" class="story-section">
            <!-- Content will be filled by JavaScript -->
        </div>
        
        <div class="story-section">
            <h3>How to Play</h3>
            <p><strong>Each Round:</strong> You'll draw a tarot card representing a situation or challenge based on historical events during the witch hunts.</p>
            
            <p><strong>Your Choices:</strong> Each card offers two options - often a choice between safety and resistance, or between individual survival and helping others.</p>
            
            <p><strong>Consequences:</strong> Your choices affect your Suspicion Level and number of Allies. Both are crucial for survival.</p>
            
            <div class="game-mechanics-preview">
                <h4>Theoretical Foundation</h4>
                <p><em>This game is based on Silvia Federici's analysis in "Caliban and the Witch." You'll experience how the witch hunts functioned as a tool of primitive accumulation, destroying women's autonomy to enforce capitalist and patriarchal control.</em></p>
            </div>
        </div>
        
        <button onclick="proceedToGameplay()" class="story-btn">Begin Your Journey</button>
        <button onclick="showRoleSelection()" class="story-btn">Choose Different Character</button>
    </div>

    <!-- Main Game Screen (Level 1) -->
    <div id="game-screen" class="container hidden">
        <h1>Caliban's Daughters</h1>
        
        <!-- Game Statistics -->
        <div class="game-stats">
            <div class="stat-item">Suspicion: <span id="suspicion">0</span>%</div>
            <div class="stat-item">Allies: <span id="allies">0</span></div>
            <div class="stat-item">Round: <span id="round">1</span>/10</div>
        </div>

        <!-- Card Display Area -->
        <div class="card-display">
            <h2 id="card-title">Ready to Begin</h2>
            <div class="card-image" id="card-image">
                📜 Caliban's Daughters
            </div>
            <p id="card-scenario">Your story as a woman during the witch hunts is about to unfold...</p>
            <p id="card-context">Each card you draw will present you with a choice that could mean survival or danger.</p>
        </div>

        <!-- Choice Buttons -->
        <div id="choices" class="choices hidden">
            <button id="choice-1" onclick="makeChoice(1)">
                <span id="choice-1-text">Choice 1</span>
            </button>
            <button id="choice-2" onclick="makeChoice(2)">
                <span id="choice-2-text">Choice 2</span>
            </button>
        </div>

        <!-- Draw Card Button -->
        <button id="draw-btn" onclick="drawCard()">Draw Card</button>

        <!-- Game Messages -->
        <div id="message" class="message hidden"></div>
    </div>

    <!-- Transition to Trial Screen -->
    <div id="trial-transition" class="container hidden">
        <div class="transition-screen">
            <h1>You Have Been Accused!</h1>
            <h3>Suspicion has reached 100%</h3>
            
            <div class="story-section">
                <p><strong>The authorities have come for you.</strong> Despite your efforts, the web of suspicion has tightened around you. You are dragged before the court to face trial for witchcraft.</p>
                
                <p><strong>Your allies from Level 1:</strong> <span id="transition-allies">0</span> people who trust you and may help during the trial.</p>
                
                <p><strong>You now face the ultimate test:</strong> a witch trial based on actual procedures from the <em>Malleus Maleficarum</em> (1486).</p>
            </div>
            
            <button onclick="startTrial()">Face Your Trial</button>
        </div>
    </div>

    <!-- === LEVEL 2 SCREENS === -->

    <!-- Trial Screen -->
    <div id="trial-screen" class="container hidden">
        <h1>The Witch Trial</h1>
        
        <!-- Game Statistics -->
        <div class="game-stats">
            <div class="stat-item">Judge's Favor: <span id="judge-favor">50</span>%</div>
            <div class="stat-item">Allies Available: <span id="trial-allies">0</span></div>
            <div class="stat-item">Phase: <span id="phase">1</span>/5</div>
        </div>

        <!-- Trial Display Area -->
        <div class="trial-display">
            <div class="trial-phase" id="phase-title">Accusation Phase</div>
            <p id="trial-scenario">You stand before the court...</p>
            <p id="trial-context">The judge watches you carefully.</p>
        </div>

        <!-- Ally Bonus Display -->
        <div id="ally-bonus" class="ally-bonus hidden">
            <strong>Ally Support:</strong> <span id="ally-message"></span>
        </div>

        <!-- Choice Buttons -->
        <div id="trial-choices" class="choices">
            <button id="trial-choice-1" onclick="makeTrialChoice(1)">
                <span id="trial-choice-1-text">Choice 1</span>
            </button>
            <button id="trial-choice-2" onclick="makeTrialChoice(2)">
                <span id="trial-choice-2-text">Choice 2</span>
            </button>
        </div>

        <!-- Trial Messages -->
        <div id="trial-message" class="message hidden"></div>
    </div>

    <!-- End Screen -->
    <div id="end-screen" class="container hidden">
        <h1 id="end-game-title">Game Over</h1>
        <h2 id="end-title"></h2>
        <p id="end-message"></p>
        <div id="theory-message" class="story-section"></div>
        <button onclick="restartGame()">Play Again</button>
    </div>

    <script>
        // === GAME DATA === 
        const TAROT_CARDS = [
            {
                title: "The Moon",
                image: "images/moonjpg",
                scenario: "Whispers spread that you meet with spirits at night.",
                context: "Rumors could quickly become deadly accusations.",
                choice1: {
                    text: "Hide for a few nights",
                    effects: { suspicion: -15 },
                    message: "You stay hidden until the rumors die down."
                },
                choice2: {
                    text: "Confront the gossips",
                    effects: { suspicion: 20, allies: 1 },
                    message: "Your bold confrontation gains respect but draws attention."
                }
            },
            {
                title: "The Tower",
                image: "images/tower.jpg",
                scenario: "A local woman betrays your secret gathering.",
                context: "Trust could be broken by fear and desperation.",
                choice1: {
                    text: "Disperse quietly",
                    effects: { suspicion: -10 },
                    message: "You scatter safely but lose the gathering."
                },
                choice2: {
                    text: "Defy the accuser",
                    effects: { suspicion: 30, allies: -1 },
                    message: "Your defiance is seen as proof of guilt."
                }
            },
            {
                title: "The High Priestess",
                image: "images/priestess.jpg",
                scenario: "A woman in labor calls for your help.",
                context: "Healing knowledge was both valued and dangerous.",
                choice1: {
                    text: "Use your knowledge",
                    effects: { suspicion: 20, allies: 1 },
                    message: "You save mother and child, but your skills are noticed."
                },
                choice2: {
                    text: "Send someone else",
                    effects: { suspicion: -10 },
                    message: "You stay safe but offer no help."
                }
            },
            {
                title: "The Hermit",
                image: "images/hermit.jpg",
                scenario: "A woman from a neighboring village seeks your help, fleeing persecution.",
                context: "Networks of support among women were crucial for survival.",
                choice1: {
                    text: "Help her escape",
                    effects: { suspicion: 5, allies: 1 },
                    message: "You risk your safety to aid another. She will remember your kindness."
                },
                choice2: {
                    text: "Turn her away",
                    effects: { suspicion: -5 },
                    message: "You protect yourself, but lose a potential ally."
                }
            },
            {
                title: "Death",
                image: "images/death.jpg",
                scenario: "A woman in the village has been accused of witchcraft and awaits trial.",
                context: "Witch trials relied on community participation. Speaking out risked attention.",
                choice1: {
                    text: "Speak in her defense",
                    effects: { suspicion: 20, allies: 1 },
                    message: "Your words cast suspicion on you, but you've shown great courage."
                },
                choice2: {
                    text: "Stay silent",
                    effects: { suspicion: -5 },
                    message: "You preserve your safety, but the guilt weighs on you."
                }
            },
            {
                title: "The Devil",
                image: "images/devil.jpg",
                scenario: "The local priest warns about women who defy natural order and church teachings.",
                context: "Religious authorities played a central role in controlling women's knowledge.",
                choice1: {
                    text: "Question his teachings secretly",
                    effects: { allies: 1 },
                    message: "Others share your doubts. You form a quiet network of dissenters."
                },
                choice2: {
                    text: "Attend church dutifully",
                    effects: { suspicion: -10 },
                    message: "Your public piety provides some protection."
                }
            },
            {
                title: "The Empress",
                image: "images/empress.jpg",
                scenario: "Your knowledge of reproductive medicine could help a suffering noblewoman.",
                context: "Control over reproduction was a key battlefield during witch hunts.",
                choice1: {
                    text: "Offer your services",
                    effects: { suspicion: -15 },
                    message: "The noblewoman recovers and becomes your protector."
                },
                choice2: {
                    text: "Keep your knowledge hidden",
                    effects: { suspicion: -5 },
                    message: "You remain safe but unseen."
                }
            },
            {
                title: "The Magician",
                image: "images/magician.jpg",
                scenario: "You discover an ancient text with forbidden knowledge.",
                context: "Literacy among women was often restricted. Traditional texts were being destroyed.",
                choice1: {
                    text: "Study it in secret",
                    effects: { allies: 1 },
                    message: "The knowledge connects you to an underground network of learned women."
                },
                choice2: {
                    text: "Destroy the text",
                    effects: { suspicion: -10 },
                    message: "You eliminate evidence that could condemn you."
                }
            },
            {
                title: "Justice",
                image: "images/justice.jpg",
                scenario: "A local official offers you protection in exchange for naming other 'suspicious' women.",
                context: "The witch hunt machinery relied on forced confessions and denunciations.",
                choice1: {
                    text: "Refuse the offer",
                    effects: { suspicion: 15, allies: 1 },
                    message: "Your integrity remains intact, earning the trust of other women."
                },
                choice2: {
                    text: "Provide false names",
                    effects: { suspicion: -10 },
                    message: "You buy yourself time, but at what cost to your conscience?"
                }
            },
            {
                title: "The Star",
                image: "images/star.jpg",
                scenario: "A midnight gathering of women is planned to share knowledge and resources.",
                context: "Women's gatherings were often criminalized but important for mutual support.",
                choice1: {
                    text: "Attend the gathering",
                    effects: { suspicion: 10, allies: 2 },
                    message: "The connection with other women strengthens your resolve and knowledge."
                },
                choice2: {
                    text: "Stay home",
                    effects: { suspicion: -5 },
                    message: "You remain isolated but avoid immediate danger."
                }
            },
            {
                title: "The Fool",
                image: "images/fool.jpg",
                scenario: "A young woman arrives organizing resistance against new enclosure laws.",
                context: "Displaced people moved between towns. Some organized resistance, but authorities labeled such groups as dangerous conspiracies.",
                choice1: {
                    text: "Join the cause",
                    effects: { suspicion: 10, allies: 1 },
                    message: "You take a leap of faith and join their movement. It's risky, but you're no longer alone."
                },
                choice2: {
                    text: "Decline and stay hidden",
                    effects: { suspicion: -5 },
                    message: "You choose safety over solidarity, watching the opportunity pass by."
                }
            },
            {
                title: "Temperance",
                image: "images/temperance.jpg",
                scenario: "Two families are feuding over a boundary dispute. Both sides ask you to help resolve it.",
                context: "Women often served as informal mediators, but had to balance being helpful without appearing to overstep male authority.",
                choice1: {
                    text: "Mediate and create peace",
                    effects: { suspicion: -10 },
                    message: "Your careful diplomacy restores harmony. Both families respect your wisdom."
                },
                choice2: {
                    text: "Subtly encourage the conflict",
                    effects: { suspicion: 10, allies: 1 },
                    message: "You stoke tensions to keep attention focused elsewhere, using chaos as cover."
                }
            }
        ];

        // Trial phases based on Malleus Maleficarum procedures
        const TRIAL_PHASES = [
            {
                title: "The Accusation",
                scenario: "The court clerk reads the charges: 'You are accused of practicing witchcraft, consorting with devils, and harming your neighbors through supernatural means.'",
                context: "According to the Malleus Maleficarum, the accused must respond to formal charges.",
                choice1: {
                    text: "Deny everything firmly",
                    effects: { judgeFavor: 10 },
                    message: "Your clear denial impresses the court with its confidence."
                },
                choice2: {
                    text: "Question the legal basis",
                    effects: { judgeFavor: 15 },
                    message: "Your knowledge of legal procedure surprises the judge."
                }
            },
            {
                title: "Witness Testimony",
                scenario: "Three neighbors testify against you. They claim they saw you speaking to your cat at midnight and that their milk soured after arguing with you.",
                context: "The Malleus required witness testimony. Your response is crucial.",
                choice1: {
                    text: "Point out contradictions",
                    effects: { judgeFavor: 20 },
                    message: "You skillfully highlight inconsistencies in their stories."
                },
                choice2: {
                    text: "Provide an alibi",
                    effects: { judgeFavor: 10 },
                    message: "Your explanation seems reasonable to the court."
                }
            },
            {
                title: "Physical Examination",
                scenario: "The court examiner claims to have found a 'devil's mark' - a small birthmark on your shoulder.",
                context: "The Malleus described how to identify supernatural marks on accused witches.",
                choice1: {
                    text: "Explain it's a birthmark",
                    effects: { judgeFavor: 5 },
                    message: "You calmly explain the natural origin of the mark."
                },
                choice2: {
                    text: "Demand a physician's opinion",
                    effects: { judgeFavor: 15 },
                    message: "Your demand for expert testimony shows legal awareness."
                }
            },
            {
                title: "The Torture Chamber",
                scenario: "The judge threatens torture to extract a confession. The implements are displayed before you.",
                context: "The Malleus provided detailed instructions for torture procedures.",
                choice1: {
                    text: "Maintain innocence",
                    effects: { judgeFavor: 25 },
                    message: "Your unwavering stance despite intimidation is noted."
                },
                choice2: {
                    text: "Appeal to canon law",
                    effects: { judgeFavor: 30 },
                    message: "Your knowledge of church law gives the judge pause."
                }
            },
            {
                title: "Final Judgment",
                scenario: "The judge prepares to pronounce sentence. This is your last chance to speak in your defense.",
                context: "The final phase determined life or death for the accused.",
                choice1: {
                    text: "Make a passionate plea",
                    effects: { judgeFavor: 15 },
                    message: "Your emotional appeal touches the court."
                },
                choice2: {
                    text: "Cite legal precedents",
                    effects: { judgeFavor: 20 },
                    message: "Your legal arguments impress the learned judge."
                }
            }
        ];

        // === GAME STATE ===
        let gameState = {
            role: "",
            suspicion: 0,
            allies: 0,
            round: 1,
            maxRounds: 10,
            deck: [],
            currentCard: null,
            inTrial: false
        };

        let trialState = {
            judgeFavor: 50,
            allies: 0,
            phase: 0,
            maxPhases: 5
        };

        // === ROLE DETAILS ===
        const ROLE_STORIES = {
            'healer': {
                title: "The Healer",
                story: `<h3>Margaret the Healer</h3>
                <p>You are Margaret, a village healer who learned the properties of herbs from your grandmother. For years, people have come to you when the official physicians failed them - or when they couldn't afford their services.</p>
                
                <p><strong>Your Knowledge:</strong> You know which plants ease pain, which can help a difficult birth, and which can prevent pregnancy. This knowledge has saved lives, but it also makes you dangerous to those who want to control women's bodies.</p>
                
                <p><strong>Your Situation:</strong> Recently, a priest has been preaching against "folk magic" and the new university-trained physicians claim your methods are primitive. Some villagers still trust you, but others whisper that your successes come from dark powers.</p>
                
                <p><strong>Starting Conditions:</strong> Medium suspicion, few initial allies, but your skills can help reduce danger in some situations.</p>`,
                suspicion: 20,
                allies: 0
            },
            'midwife': {
                title: "The Midwife", 
                story: `<h3>Agnes the Midwife</h3>
                <p>You are Agnes, a midwife who has delivered hundreds of babies. Mothers trust you with their most vulnerable moments, and you hold knowledge about women's bodies that few others possess.</p>
                
                <p><strong>Your Knowledge:</strong> You understand childbirth, can ease labor pains, and know the old songs and rituals that comfort mothers. You also know which herbs can end an unwanted pregnancy - knowledge that's becoming increasingly dangerous.</p>
                
                <p><strong>Your Situation:</strong> The Church is trying to control childbirth, requiring priests to be present at births. Male physicians are claiming that women are unfit to practice medicine. Your very profession is under attack.</p>
                
                <p><strong>Starting Conditions:</strong> Some suspicion but stronger community support. Many mothers will defend you, giving you more initial allies.</p>`,
                suspicion: 25,
                allies: 1
            },
            'wise-woman': {
                title: "The Wise Woman",
                story: `<h3>Eleanor the Wise Woman</h3>
                <p>You are Eleanor, keeper of the old ways. You remember the stories, know the seasonal rituals, and understand the connections between earth, sky, and human life that others have forgotten.</p>
                
                <p><strong>Your Knowledge:</strong> You know weather patterns, can read signs in nature, and remember the old laws that protected common lands. You also hold knowledge of traditions that the Church calls "pagan" - knowledge that's becoming illegal.</p>
                
                <p><strong>Your Situation:</strong> As common lands are enclosed and old customs banned, your role as keeper of traditional knowledge makes you a symbol of the disappearing world. Some see you as a relic, others as a threat to the new order.</p>
                
                <p><strong>Starting Conditions:</strong> Higher suspicion but respected by those who remember the old ways. Your wisdom can sometimes attract allies who seek to preserve tradition.</p>`,
                suspicion: 35,
                allies: 1
            },
            'dissenter': {
                title: "The Dissenter",
                story: `<h3>Joanna the Dissenter</h3>
                <p>You are Joanna, a woman who refuses to accept the new restrictions on your life. When laws were passed requiring women to have male guardians, you spoke out. When common lands were enclosed, you protested.</p>
                
                <p><strong>Your Stance:</strong> You believe women should have the right to live independently, to practice trades, to speak in public. You've seen how the new economic system enriches a few while impoverishing many, and you're not afraid to say so.</p>
                
                <p><strong>Your Situation:</strong> Your outspokenness has already marked you as a troublemaker. Authorities know your name and watch your activities. But your courage has also inspired other women who share your views.</p>
                
                <p><strong>Starting Conditions:</strong> High suspicion from your known resistance, but you've already gathered allies who believe in your cause.</p>`,
                suspicion: 40,
                allies: 2
            }
        };

        // === NAVIGATION FUNCTIONS ===
        
        function showIntroStory() {
            document.getElementById('intro-story').classList.remove('hidden');
            document.getElementById('historical-context').classList.add('hidden');
            document.getElementById('role-selection').classList.add('hidden');
            document.getElementById('role-details').classList.add('hidden');
        }

        function showHistoricalContext() {
            document.getElementById('intro-story').classList.add('hidden');
            document.getElementById('historical-context').classList.remove('hidden');
            document.getElementById('role-selection').classList.add('hidden');
            document.getElementById('role-details').classList.add('hidden');
        }

        function showRoleSelection() {
            document.getElementById('intro-story').classList.add('hidden');
            document.getElementById('historical-context').classList.add('hidden');
            document.getElementById('role-selection').classList.remove('hidden');
            document.getElementById('role-details').classList.add('hidden');
            document.getElementById('character-intro').classList.add('hidden');
        }

        function showRoleDetails(role) {
            document.getElementById('intro-story').classList.add('hidden');
            document.getElementById('historical-context').classList.add('hidden');
            document.getElementById('role-selection').classList.add('hidden');
            document.getElementById('role-details').classList.remove('hidden');
            
            const roleData = ROLE_STORIES[role];
            document.getElementById('role-story-content').innerHTML = roleData.story;
            document.getElementById('start-game-btn').onclick = () => startGame(role);
        }

        // === GAME FUNCTIONS ===

        function startGame(selectedRole) {
            gameState.role = selectedRole;
            gameState.suspicion = ROLE_STORIES[selectedRole].suspicion;
            gameState.allies = ROLE_STORIES[selectedRole].allies;
            gameState.round = 1;
            gameState.inTrial = false;
            
            gameState.deck = [...TAROT_CARDS];
            shuffleArray(gameState.deck);
            
            showCharacterIntroduction(selectedRole);
        }

        function showCharacterIntroduction(role) {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('character-intro').classList.remove('hidden');
            
            const roleData = ROLE_STORIES[role];
            document.getElementById('character-intro-content').innerHTML = `
                <h2>You are ${roleData.title}</h2>
                <div class="character-setup">
                    <p><strong>Your situation:</strong> The year is 1580. The witch hunts have been spreading across Europe for decades. You live in a small village where everyone knows everyone else's business.</p>
                    
                    <p><strong>Your knowledge makes you valuable...</strong> People come to you when they need help. But that same knowledge makes you dangerous in the eyes of the authorities.</p>
                    
                    <p><strong>Your starting position:</strong></p>
                    <ul>
                        <li>Suspicion Level: ${roleData.suspicion}% (how much attention you've already drawn)</li>
                        <li>Allies: ${roleData.allies} (people who trust and support you)</li>
                    </ul>
                    
                    <p><em>Your goal is to survive 10 rounds of challenges while managing suspicion and building alliances. Too much suspicion (100%) means capture and trial. Allies can help protect you and provide alternative paths to survival.</em></p>
                </div>
            `;
        }

        function proceedToGameplay() {
            document.getElementById('character-intro').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            updateDisplay();
            
            showMessage(`Your journey begins as ${ROLE_STORIES[gameState.role].title.toLowerCase()}. The village feels tense today. Someone mentioned seeing lights in the forest last night... Click "Draw Card" when you're ready for your first challenge.`);
        }

        function drawCard() {
            if (gameState.deck.length === 0) {
                endGame('survived');
                return;
            }
            
            gameState.currentCard = gameState.deck.pop();
            
            document.getElementById('card-title').textContent = gameState.currentCard.title;
            document.getElementById('card-scenario').textContent = gameState.currentCard.scenario;
            document.getElementById('card-context').textContent = gameState.currentCard.context;
            
            // Show tarot card symbol as fallback
            const cardImageEl = document.getElementById('card-image');
            const symbols = {
                "The Moon": "🌙",
                "The Tower": "🗼",
                "The High Priestess": "👸",
                "The Hermit": "🧙‍♀️",
                "Death": "💀",
                "The Devil": "😈",
                "The Empress": "👑",
                "The Magician": "🔮",
                "Justice": "⚖️",
                "The Star": "⭐",
                "The Fool": "🃏",
                "Temperance": "🏺"
            };
            cardImageEl.textContent = symbols[gameState.currentCard.title] || "🎴";
            
            document.getElementById('choice-1-text').textContent = gameState.currentCard.choice1.text;
            document.getElementById('choice-2-text').textContent = gameState.currentCard.choice2.text;
            document.getElementById('choices').classList.remove('hidden');
            
            document.getElementById('draw-btn').classList.add('hidden');
            document.getElementById('message').classList.add('hidden');
        }

        function makeChoice(choiceNumber) {
            const choice = choiceNumber === 1 ? gameState.currentCard.choice1 : gameState.currentCard.choice2;
            
            applyEffects(choice.effects);
            showMessage(choice.message);
            
            document.getElementById('choices').classList.add('hidden');
            
            // Check if suspicion reached 100% - if so, go to trial
            if (gameState.suspicion >= 100) {
                setTimeout(() => transitionToTrial(), 2000);
                return;
            }
            
            gameState.round++;
            if (gameState.round > gameState.maxRounds) {
                setTimeout(() => endGame('survived'), 2000);
                return;
            }
            
            updateDisplay();
            document.getElementById('draw-btn').classList.remove('hidden');
        }

        function applyEffects(effects) {
            if (effects.suspicion) {
                gameState.suspicion += effects.suspicion;
                gameState.suspicion = Math.max(0, Math.min(100, gameState.suspicion));
            }
            
            if (effects.allies) {
                gameState.allies += effects.allies;
                gameState.allies = Math.max(0, gameState.allies);
            }
        }

        function updateDisplay() {
            document.getElementById('suspicion').textContent = gameState.suspicion;
            document.getElementById('allies').textContent = gameState.allies;
            document.getElementById('round').textContent = gameState.round;
        }

        function showMessage(message) {
            document.getElementById('message').textContent = message;
            document.getElementById('message').classList.remove('hidden');
        }

        // === TRANSITION TO TRIAL ===
        function transitionToTrial() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('trial-transition').classList.remove('hidden');
            
            document.getElementById('transition-allies').textContent = gameState.allies;
        }

        function startTrial() {
            // Initialize trial state with allies from Level 1
            trialState.allies = gameState.allies;
            trialState.judgeFavor = 50;
            trialState.phase = 0;
            gameState.inTrial = true;
            
            document.getElementById('trial-transition').classList.add('hidden');
            document.getElementById('trial-screen').classList.remove('hidden');
            
            updateTrialDisplay();
            showCurrentPhase();
        }

        // === TRIAL FUNCTIONS ===
        function showCurrentPhase() {
            const phase = TRIAL_PHASES[trialState.phase];
            
            document.getElementById('phase-title').textContent = phase.title;
            document.getElementById('trial-scenario').textContent = phase.scenario;
            document.getElementById('trial-context').textContent = phase.context;
            
            document.getElementById('trial-choice-1-text').textContent = phase.choice1.text;
            document.getElementById('trial-choice-2-text').textContent = phase.choice2.text;
            
            // Hide any previous messages
            document.getElementById('trial-message').classList.add('hidden');
            document.getElementById('ally-bonus').classList.add('hidden');
        }

        function makeTrialChoice(choiceNumber) {
            const phase = TRIAL_PHASES[trialState.phase];
            const choice = choiceNumber === 1 ? phase.choice1 : phase.choice2;
            
            // Apply base effects
            applyTrialEffects(choice.effects);
            
            // Show choice result
            showTrialMessage(choice.message);
            
            // Apply ally bonus if available
            if (trialState.allies > 0 && Math.random() < 0.6) {
                applyAllyBonus();
            }
            
            // Check if trial should end
            setTimeout(() => {
                trialState.phase++;
                if (trialState.phase >= trialState.maxPhases) {
                    endTrial();
                } else {
                    showCurrentPhase();
                    updateTrialDisplay();
                }
            }, 2500);
        }

        function applyTrialEffects(effects) {
            if (effects.judgeFavor) {
                trialState.judgeFavor += effects.judgeFavor;
                trialState.judgeFavor = Math.max(0, Math.min(100, trialState.judgeFavor));
            }
            updateTrialDisplay();
        }

        function applyAllyBonus() {
            const bonuses = [
                "A neighbor testifies to your good character",
                "Someone provides evidence supporting your alibi",
                "A respected villager speaks in your defense",
                "Your ally brings a witness to contradict the accusers"
            ];
            
            const bonus = bonuses[Math.floor(Math.random() * bonuses.length)];
            trialState.judgeFavor += 10;
            trialState.judgeFavor = Math.min(100, trialState.judgeFavor);
            trialState.allies--;
            
            document.getElementById('ally-message').textContent = bonus + " (+10 Judge's Favor)";
            document.getElementById('ally-bonus').classList.remove('hidden');
            updateTrialDisplay();
        }

        function updateTrialDisplay() {
            document.getElementById('judge-favor').textContent = trialState.judgeFavor;
            document.getElementById('trial-allies').textContent = trialState.allies;
            document.getElementById('phase').textContent = trialState.phase + 1;
        }

        function showTrialMessage(text) {
            const messageEl = document.getElementById('trial-message');
            messageEl.textContent = text;
            messageEl.classList.remove('hidden');
        }

        function endTrial() {
            document.getElementById('trial-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            
            document.getElementById('end-game-title').textContent = "Trial Complete";
            
            if (trialState.judgeFavor >= 80) {
                showAcquittalEnding();
            } else if (trialState.judgeFavor >= 60) {
                showBanishmentEnding();
            } else if (trialState.judgeFavor >= 40) {
                showImprisonmentEnding();
            } else {
                showExecutionEnding();
            }
        }

        function showAcquittalEnding() {
            document.getElementById('end-title').textContent = "Acquitted!";
            document.getElementById('end-message').innerHTML = `
                <p><strong>The judge finds you innocent!</strong> Your combination of legal knowledge and strong defense convinced the court.</p>
                <p><em>Final Judge's Favor: ${trialState.judgeFavor}%</em></p>
            `;
            
            document.getElementById('theory-message').innerHTML = `
                <h3>Historical Reality</h3>
                <p>Full acquittals were rare but possible, especially when the accused demonstrated legal knowledge or had strong community support. Your success represents the few who overcame the system through preparation and allies.</p>
                <p><strong>Your Journey:</strong> Role: ${ROLE_STORIES[gameState.role].title}, Level 1 Allies: ${gameState.allies + trialState.allies}, Final Suspicion in Level 1: 100%</p>
            `;
        }

        function showBanishmentEnding() {
            document.getElementById('end-title').textContent = "Banished";
            document.getElementById('end-message').innerHTML = `
                <p><strong>You are banished from the region.</strong> The judge spares your life but exiles you permanently.</p>
                <p><em>Final Judge's Favor: ${trialState.judgeFavor}%</em></p>
            `;
            
            document.getElementById('theory-message').innerHTML = `
                <h3>Historical Context</h3>
                <p>Banishment was sometimes used as a compromise sentence when evidence was insufficient for execution but suspicion remained high. Many women survived this way, though they lost everything.</p>
                <p><strong>Your Journey:</strong> Role: ${ROLE_STORIES[gameState.role].title}, Level 1 Allies: ${gameState.allies + trialState.allies}, Final Suspicion in Level 1: 100%</p>
            `;
        }

        function showImprisonmentEnding() {
            document.getElementById('end-title').textContent = "Imprisoned";
            document.getElementById('end-message').innerHTML = `
                <p><strong>You are sentenced to life imprisonment.</strong> You escape death but will spend your remaining years in confinement.</p>
                <p><em>Final Judge's Favor: ${trialState.judgeFavor}%</em></p>
            `;
            
            document.getElementById('theory-message').innerHTML = `
                <h3>Historical Reality</h3>
                <p>According to the Malleus Maleficarum, perpetual imprisonment "on bread and water" was sometimes offered to those who confessed and provided information about other witches.</p>
                <p><strong>Your Journey:</strong> Role: ${ROLE_STORIES[gameState.role].title}, Level 1 Allies: ${gameState.allies + trialState.allies}, Final Suspicion in Level 1: 100%</p>
            `;
        }

        function showExecutionEnding() {
            document.getElementById('end-title').textContent = "Condemned";
            document.getElementById('end-message').innerHTML = `
                <p><strong>You are sentenced to death.</strong> Despite your efforts, the court finds you guilty of witchcraft.</p>
                <p><em>Final Judge's Favor: ${trialState.judgeFavor}%</em></p>
            `;
            
            document.getElementById('theory-message').innerHTML = `
                <h3>The Tragic Reality</h3>
                <p>Most witch trials ended in execution. The Malleus Maleficarum was designed to ensure conviction, not justice. Your fate represents the thousands of women who faced this same unjust system.</p>
                <p><strong>Your Journey:</strong> Role: ${ROLE_STORIES[gameState.role].title}, Level 1 Allies: ${gameState.allies + trialState.allies}, Final Suspicion in Level 1: 100%</p>
            `;
        }

        function endGame(result) {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            
            document.getElementById('end-game-title').textContent = "Level 1 Complete";
            
            let title, message, theory;
            
            if (result === 'survived') {
                if (gameState.suspicion >= 70) {
                    title = "Barely Survived";
                    message = `You managed to survive all 10 rounds, but with ${gameState.suspicion}% suspicion, you live in constant fear. Every day could be your last.`;
                    theory = `Many women lived under constant surveillance and fear, their autonomy severely restricted even if they avoided execution.`;
                } else if (gameState.suspicion >= 40) {
                    title = "Cautious Survivor";
                    message = `You survived by carefully balancing resistance with discretion. With ${gameState.suspicion}% suspicion and ${gameState.allies} allies, you've found a precarious safety.`;
                    theory = `Success often required careful calculation and compromise, forcing women to constantly police their own behavior.`;
                } else {
                    title = "Thrived in Secret";
                    message = `Remarkably, you kept suspicion low (${gameState.suspicion}%) while building ${gameState.allies} allies. You represent the hidden networks that preserved women's knowledge.`;
                    theory = `Some women successfully built underground support systems that kept alive the knowledge and solidarity that authorities sought to destroy.`;
                }
            }
            
            document.getElementById('end-title').textContent = title;
            document.getElementById('end-message').textContent = message;
            document.getElementById('theory-message').innerHTML = `
                <h4>Historical Analysis</h4>
                <p>${theory}</p>
                <p><strong>Final Stats:</strong> Suspicion: ${gameState.suspicion}%, Allies: ${gameState.allies}, Rounds Survived: ${gameState.round - 1}</p>
                <p><em>You have completed Level 1 and can continue to other scenarios with different outcomes!</em></p>
            `;
        }

        function restartGame() {
            gameState = {
                role: "",
                suspicion: 0,
                allies: 0,
                round: 1,
                maxRounds: 10,
                deck: [],
                currentCard: null,
                inTrial: false
            };
            
            trialState = {
                judgeFavor: 50,
                allies: 0,
                phase: 0,
                maxPhases: 5
            };
            
            document.getElementById('end-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            showIntroStory();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Initialize game
        document.addEventListener('DOMContentLoaded', function() {
            showIntroStory();
        });
    </script>
</body>
</html>