<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caliban's Daughters - Level 2: The Trial</title>
    <style>
        /* === SIMPLE STYLING === */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600&family=Uncial+Antiqua&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');

        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, #2c1810 0%, #1a0f0a 50%, #0d0704 100%);
            background-attachment: fixed;
            color: #d4c4a8;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            min-height: 100vh;
            font-size: 18px;
            line-height: 1.6;
        }
        /* Parchment texture overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(139, 69, 19, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(160, 82, 45, 0.05) 0%, transparent 50%);
            background-size: 200px 200px, 150px 150px;
            pointer-events: none;
            z-index: -1;
        }

        .container {
            text-align: center;
            background: linear-gradient(145deg, #3d2817 0%, #2a1b0f 100%);
            padding: 40px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 
                inset 0 0 30px rgba(139, 69, 19, 0.2),
                0 8px 32px rgba(0, 0, 0, 0.6);
            border: 3px solid #654321;
            position: relative;
        }

        /* Medieval illuminated manuscript corners */
        .container::before,
        .container::after {
            content: '‚ù¶';
            position: absolute;
            font-size: 28px;
            color: #cd853f;
            font-family: 'Uncial Antiqua', serif;
            text-shadow: 0 0 8px rgba(205, 133, 63, 0.5);
        }

        .container::before {
            top: 15px;
            left: 15px;
        }

        .container::after {
            bottom: 15px;
            right: 15px;
            transform: rotate(180deg);
        }

        h1 {
            font-family: 'Uncial Antiqua', serif;
            color: #cd853f;
            margin-bottom: 15px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            letter-spacing: 2px;
        }

        .level-header {
            background-color: rgba(139, 69, 19, 0.3);
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 3px solid #cd853f;
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 15px;
            background-color: #654321;
            border-radius: 5px;
        }

        .stat-item {
            font-weight: bold;
        }

        .trial-display {
            background-color: #8b4513;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px auto;
            min-height: 200px;
        }

        .trial-phase {
            font-size: 1.1em;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .story-section {
            margin: 20px 0;
            padding: 20px;
            background-color: #654321;
            border-radius: 8px;
            line-height: 1.6;
        }

        .choices {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        button {
            padding: 15px 25px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #8b4513;
            color: white;
            flex: 1;
        }

        button:hover {
            background-color: #654321;
        }

        .hidden {
            display: none;
        }

        .message {
            background-color: #654321;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-style: italic;
        }

        .ally-bonus {
            background-color: rgba(205, 133, 63, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 3px solid #cd853f;
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div id="start-screen" class="container">
        <h1>Caliban's Daughters</h1>
        <h2>Level 2: The Trial</h2>
        
        <div class="level-header">
            <h3>You Have Been Accused</h3>
            <p>Despite your efforts in Level 1, suspicion has grown. You now face the ultimate test: a witch trial based on actual procedures from the <em>Malleus Maleficarum</em> (1486).</p>
            
            <div id="level1-results" style="margin: 20px 0; padding: 15px; background-color: #0f3460; border-radius: 5px;">
                <p>Loading your results from Level 1...</p>
            </div>
        </div>
        
        <button onclick="startTrial()">Begin Your Trial</button>
        <button onclick="window.location.href='index.html'" style="background-color: #16213e; margin-left: 10px;">Return to Level 1</button>
    </div>

    <!-- Trial Screen -->
    <div id="trial-screen" class="container hidden">
        <h1>The Witch Trial</h1>
        
        <!-- Game Statistics -->
        <div class="game-stats">
            <div class="stat-item">Judge's Favor: <span id="judge-favor">50</span>%</div>
            <div class="stat-item">Allies Available: <span id="allies">0</span></div>
            <div class="stat-item">Phase: <span id="phase">1</span>/5</div>
        </div>

        <!-- Trial Display Area -->
        <div class="trial-display">
            <div class="trial-phase" id="phase-title">Accusation Phase</div>
            <p id="trial-scenario">You stand before the court...</p>
            <p id="trial-context">The judge watches you carefully.</p>
        </div>

        <!-- Ally Bonus Display -->
        <div id="ally-bonus" class="ally-bonus hidden">
            <strong>Ally Support:</strong> <span id="ally-message"></span>
        </div>

        <!-- Choice Buttons -->
        <div id="choices" class="choices">
            <button id="choice-1" onclick="makeChoice(1)">
                <span id="choice-1-text">Choice 1</span>
            </button>
            <button id="choice-2" onclick="makeChoice(2)">
                <span id="choice-2-text">Choice 2</span>
            </button>
        </div>

        <!-- Trial Messages -->
        <div id="message" class="message hidden"></div>
    </div>

    <!-- End Screen -->
    <div id="end-screen" class="container hidden">
        <h1>Trial Complete</h1>
        <h2 id="end-title"></h2>
        <p id="end-message"></p>
        <div id="historical-note" class="story-section"></div>
        <button onclick="restartTrial()">Try Again</button>
    </div>

    <script>
        // Load Level 1 results automatically
        window.onload = function() {
            const level1Data = localStorage.getItem('calibansLevel1');
            if (level1Data) {
                const results = JSON.parse(level1Data);
                document.getElementById('level1-results').innerHTML = `
                    <p><strong>Results from Level 1:</strong></p>
                    <p>Role: ${ROLE_STORIES[results.role] ? ROLE_STORIES[results.role].title : results.role}</p>
                    <p>Allies: ${results.allies}</p>
                    <p>Final Suspicion: ${results.suspicion}%</p>
                `;
                
                // Auto-set ally count
                trialState.allies = results.allies;
            } else {
                document.getElementById('level1-results').innerHTML = `
                    <p style="color: #e94560;"><strong>No Level 1 data found.</strong></p>
                    <p><a href="index.html" style="color: #eee;">Play Level 1 first</a> to get the full experience!</p>
                `;
                trialState.allies = 0; // Default if no Level 1 data
            }
        };

        // Add role data for Level 2 display
        const ROLE_STORIES = {
            'healer': { title: "The Healer" },
            'midwife': { title: "The Midwife" },
            'wise-woman': { title: "The Wise Woman" },
            'dissenter': { title: "The Dissenter" }
        };
        // Trial phases based on Malleus Maleficarum procedures
        const TRIAL_PHASES = [
            {
                title: "The Accusation",
                scenario: "The court clerk reads the charges: 'You are accused of practicing witchcraft, consorting with devils, and harming your neighbors through supernatural means.'",
                context: "According to the Malleus Maleficarum, the accused must respond to formal charges.",
                choice1: {
                    text: "Deny everything firmly",
                    effects: { judgeFavor: +10 },
                    message: "Your clear denial impresses the court with its confidence."
                },
                choice2: {
                    text: "Question the legal basis",
                    effects: { judgeFavor: +15 },
                    message: "Your knowledge of legal procedure surprises the judge."
                }
            },
            {
                title: "Witness Testimony",
                scenario: "Three neighbors testify against you. They claim they saw you speaking to your cat at midnight and that their milk soured after arguing with you.",
                context: "The Malleus required witness testimony. Your response is crucial.",
                choice1: {
                    text: "Point out contradictions",
                    effects: { judgeFavor: +20 },
                    message: "You skillfully highlight inconsistencies in their stories."
                },
                choice2: {
                    text: "Provide an alibi",
                    effects: { judgeFavor: +10 },
                    message: "Your explanation seems reasonable to the court."
                }
            },
            {
                title: "Physical Examination",
                scenario: "The court examiner claims to have found a 'devil's mark' - a small birthmark on your shoulder.",
                context: "The Malleus described how to identify supernatural marks on accused witches.",
                choice1: {
                    text: "Explain it's a birthmark",
                    effects: { judgeFavor: +5 },
                    message: "You calmly explain the natural origin of the mark."
                },
                choice2: {
                    text: "Demand a physician's opinion",
                    effects: { judgeFavor: +15 },
                    message: "Your demand for expert testimony shows legal awareness."
                }
            },
            {
                title: "The Torture Chamber",
                scenario: "The judge threatens torture to extract a confession. The implements are displayed before you.",
                context: "The Malleus provided detailed instructions for torture procedures.",
                choice1: {
                    text: "Maintain innocence",
                    effects: { judgeFavor: +25 },
                    message: "Your unwavering stance despite intimidation is noted."
                },
                choice2: {
                    text: "Appeal to canon law",
                    effects: { judgeFavor: +30 },
                    message: "Your knowledge of church law gives the judge pause."
                }
            },
            {
                title: "Final Judgment",
                scenario: "The judge prepares to pronounce sentence. This is your last chance to speak in your defense.",
                context: "The final phase determined life or death for the accused.",
                choice1: {
                    text: "Make a passionate plea",
                    effects: { judgeFavor: +15 },
                    message: "Your emotional appeal touches the court."
                },
                choice2: {
                    text: "Cite legal precedents",
                    effects: { judgeFavor: +20 },
                    message: "Your legal arguments impress the learned judge."
                }
            }
        ];

        // Game state
        let trialState = {
            judgeFavor: 50,
            allies: 0,
            phase: 0,
            maxPhases: 5
        };

        function startTrial() {
            // Get data from Level 1 if available
            const level1Data = localStorage.getItem('calibansLevel1');
            if (level1Data) {
                const results = JSON.parse(level1Data);
                trialState.allies = results.allies;
            }
            
            trialState.judgeFavor = 50;
            trialState.phase = 0;
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('trial-screen').classList.remove('hidden');
            
            updateDisplay();
            showCurrentPhase();
        }

        function showCurrentPhase() {
            const phase = TRIAL_PHASES[trialState.phase];
            
            document.getElementById('phase-title').textContent = phase.title;
            document.getElementById('trial-scenario').textContent = phase.scenario;
            document.getElementById('trial-context').textContent = phase.context;
            
            document.getElementById('choice-1-text').textContent = phase.choice1.text;
            document.getElementById('choice-2-text').textContent = phase.choice2.text;
            
            // Hide any previous messages
            document.getElementById('message').classList.add('hidden');
            document.getElementById('ally-bonus').classList.add('hidden');
        }

        function makeChoice(choiceNumber) {
            const phase = TRIAL_PHASES[trialState.phase];
            const choice = choiceNumber === 1 ? phase.choice1 : phase.choice2;
            
            // Apply base effects
            applyEffects(choice.effects);
            
            // Show choice result
            showMessage(choice.message);
            
            // Apply ally bonus if available
            if (trialState.allies > 0 && Math.random() < 0.6) {
                applyAllyBonus();
            }
            
            // Check if trial should end
            setTimeout(() => {
                trialState.phase++;
                if (trialState.phase >= trialState.maxPhases) {
                    endTrial();
                } else {
                    showCurrentPhase();
                    updateDisplay();
                }
            }, 2500);
        }

        function applyEffects(effects) {
            if (effects.judgeFavor) {
                trialState.judgeFavor += effects.judgeFavor;
                trialState.judgeFavor = Math.max(0, Math.min(100, trialState.judgeFavor));
            }
            updateDisplay();
        }

        function applyAllyBonus() {
            const bonuses = [
                "A neighbor testifies to your good character",
                "Someone provides evidence supporting your alibi",
                "A respected villager speaks in your defense",
                "Your ally brings a witness to contradict the accusers"
            ];
            
            const bonus = bonuses[Math.floor(Math.random() * bonuses.length)];
            trialState.judgeFavor += 10;
            trialState.judgeFavor = Math.min(100, trialState.judgeFavor);
            trialState.allies--;
            
            document.getElementById('ally-message').textContent = bonus + " (+10 Judge's Favor)";
            document.getElementById('ally-bonus').classList.remove('hidden');
            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('judge-favor').textContent = trialState.judgeFavor;
            document.getElementById('allies').textContent = trialState.allies;
            document.getElementById('phase').textContent = trialState.phase + 1;
        }

        function showMessage(text) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.classList.remove('hidden');
        }

        function endTrial() {
            document.getElementById('trial-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            
            if (trialState.judgeFavor >= 80) {
                showAcquittalEnding();
            } else if (trialState.judgeFavor >= 60) {
                showBanishmentEnding();
            } else if (trialState.judgeFavor >= 40) {
                showImprisonmentEnding();
            } else {
                showExecutionEnding();
            }
        }

        function showAcquittalEnding() {
            document.getElementById('end-title').textContent = "Acquitted!";
            document.getElementById('end-message').innerHTML = `
                <p><strong>The judge finds you innocent!</strong> Your combination of legal knowledge and strong defense convinced the court.</p>
                <p><em>Final Judge's Favor: ${trialState.judgeFavor}%</em></p>
            `;
            
            document.getElementById('historical-note').innerHTML = `
                <h3>Historical Reality</h3>
                <p>Full acquittals were rare but possible, especially when the accused demonstrated legal knowledge or had strong community support. Your success represents the few who overcame the system through preparation and allies.</p>
            `;
        }

        function showBanishmentEnding() {
            document.getElementById('end-title').textContent = "Banished";
            document.getElementById('end-message').innerHTML = `
                <p><strong>You are banished from the region.</strong> The judge spares your life but exiles you permanently.</p>
                <p><em>Final Judge's Favor: ${trialState.judgeFavor}%</em></p>
            `;
            
            document.getElementById('historical-note').innerHTML = `
                <h3>Historical Context</h3>
                <p>Banishment was sometimes used as a compromise sentence when evidence was insufficient for execution but suspicion remained high. Many women survived this way, though they lost everything.</p>
            `;
        }

        function showImprisonmentEnding() {
            document.getElementById('end-title').textContent = "Imprisoned";
            document.getElementById('end-message').innerHTML = `
                <p><strong>You are sentenced to life imprisonment.</strong> You escape death but will spend your remaining years in confinement.</p>
                <p><em>Final Judge's Favor: ${trialState.judgeFavor}%</em></p>
            `;
            
            document.getElementById('historical-note').innerHTML = `
                <h3>Historical Reality</h3>
                <p>According to the Malleus Maleficarum, perpetual imprisonment "on bread and water" was sometimes offered to those who confessed and provided information about other witches.</p>
            `;
        }

        function showExecutionEnding() {
            document.getElementById('end-title').textContent = "Condemned";
            document.getElementById('end-message').innerHTML = `
                <p><strong>You are sentenced to death.</strong> Despite your efforts, the court finds you guilty of witchcraft.</p>
                <p><em>Final Judge's Favor: ${trialState.judgeFavor}%</em></p>
            `;
            
            document.getElementById('historical-note').innerHTML = `
                <h3>The Tragic Reality</h3>
                <p>Most witch trials ended in execution. The Malleus Maleficarum was designed to ensure conviction, not justice. Your fate represents the thousands of women who faced this same unjust system.</p>
            `;
        }

        function restartTrial() {
            trialState = {
                judgeFavor: 50,
                allies: 0,
                phase: 0,
                maxPhases: 5
            };
            
            document.getElementById('end-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
        }
    </script>
</body>
</html>